var st=Object.defineProperty;var lt=(u,t,o)=>t in u?st(u,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):u[t]=o;var tt=(u,t,o)=>lt(u,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function o(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(e){if(e.ep)return;e.ep=!0;const r=o(e);fetch(e.href,r)}})();const L={rootOuterPx:12,rootInset:.5,nodeRadiusPx:2,nodeStrokePx:1,haloPx:0,colors:{greenFill:"#00e676",greenStroke:"rgba(255,255,255,0.95)",redFill:"#ff5252",redStroke:"rgba(255,255,255,0.6)",rootFill:"#ffd54f",rootStroke:"#333",linkStroke:"rgba(255,255,255,0.85)",blockFill:"rgba(80,80,80,0.7)",blockStroke:"rgba(180,180,180,0.9)"},animationDuration:400,framePadding:40,highlightFlashDuration:600,debug:!1},dt={blockLineWidth:.5,linkLineWidth:.7,rootLineWidth:1.4};class ct{constructor(t,o){this.statusPanel=t,this.config=o,this.statusEl=document.getElementById("status"),this.debugPanel=document.getElementById("debug-panel"),this.statusLogPanel=document.getElementById("statusPanel")}log(t,o="info"){if(console.log(`[${o.toUpperCase()}] ${t}`),this.debugPanel){const i=document.createElement("div");i.className=`log-${o}`,i.textContent=`[${new Date().toLocaleTimeString()}] ${t}`,this.debugPanel.appendChild(i),this.debugPanel.scrollTop=this.debugPanel.scrollHeight}if(this.statusLogPanel){const i=new Date().toLocaleTimeString(),r=this.statusLogPanel.innerHTML.split("<br>").slice(-7),n=o==="error"?"#c62828":o==="success"?"#2e7d32":"#666";this.statusLogPanel.innerHTML=[...r,`<span style="color: ${n}">[${i}] ${t}</span>`].join("<br>"),this.statusLogPanel.scrollTop=this.statusLogPanel.scrollHeight}}warn(t){this.log(t,"warn")}error(t){this.log(t,"error")}updateStatus(t,o="info"){this.statusEl&&(this.statusEl.textContent=t,this.statusEl.style.color=o==="error"?"#d32f2f":o==="success"?"#388e3c":"#666"),this.log(t,o)}}const H=class H{static addPolygonPath(t,o,i){H.pathCallCount++;const e=new Path2D;let r=0;for(const n of t){if(!(n!=null&&n.length))continue;r++;const l=o?[n[0][1],n[0][0]]:n[0];e.moveTo(l[0],l[1]);for(let s=1;s<n.length;s++){const c=o?[n[s][1],n[s][0]]:n[s];e.lineTo(c[0],c[1])}e.closePath()}r>0&&i.push(e)}static calculateCentroid(t,o){let i=0,e=0,r=0;for(let n=0;n<t.length-1;n++){const l=o?[t[n][1],t[n][0]]:t[n],s=o?[t[n+1][1],t[n+1][0]]:t[n+1],c=l[0]*s[1]-s[0]*l[1];i+=c,e+=(l[0]+s[0])*c,r+=(l[1]+s[1])*c}if(Math.abs(i)<1e-12){let n=0,l=0;for(const s of t){const c=o?s[1]:s[0],d=o?s[0]:s[1];n+=c,l+=d}return[n/t.length,l/t.length]}return i*=.5,[e/(6*i),r/(6*i)]}static detectSwap(t){if(!Array.isArray(t)||t.length<2)return!1;const o=t[0],i=t[1];return o>40&&o<43&&i<-80&&i>-90}};tt(H,"pathCallCount",0);let E=H;class at{constructor(t){this.logger=t}async loadBlocks(t,o,i,e,r){var n,l,s,c,d,f,g,h,m;try{this.logger.updateStatus("Loading blocks.geojson...","info");const p=await fetch("data/blocks.json");if(!p.ok)throw new Error(`Failed to fetch blocks.json: ${p.status} ${p.statusText} `);const b=await p.json();if(!b.features||!Array.isArray(b.features))throw new Error("Invalid GeoJSON: missing features array");const $=b.features[0];let z;((n=$==null?void 0:$.geometry)==null?void 0:n.type)==="Polygon"?z=(s=(l=$.geometry.coordinates)==null?void 0:l[0])==null?void 0:s[0]:((c=$==null?void 0:$.geometry)==null?void 0:c.type)==="MultiPolygon"&&(z=(g=(f=(d=$.geometry.coordinates)==null?void 0:d[0])==null?void 0:f[0])==null?void 0:g[0]);const C=E.detectSwap(z);this.logger.log(`Coordinate order: ${C?"LAT,LON (swapping)":"LON,LAT"}`),this.logger.log(`Sample coord for swap detection: ${JSON.stringify(z)}`),this.logger.log(`Processing ${b.features.length} features...`);let q=0,K=0,Q=0,N=1/0,A=1/0,F=-1/0,O=-1/0,j=0;for(const k of b.features){const v=k.geometry;if(!v){Q++;continue}let W=1/0,X=1/0,U=-1/0,Y=-1/0;const Z=w=>{for(const D of w){const B=C?D[1]:D[0],M=C?D[0]:D[1];j<3&&(this.logger.log(`Coord ${j}: raw=${JSON.stringify(D)}, x=${B}, y=${M}`),j++),B<N&&(N=B),M<A&&(A=M),B>F&&(F=B),M>O&&(O=M),B<W&&(W=B),M<X&&(X=M),B>U&&(U=B),M>Y&&(Y=M)}};if(v.type==="Polygon"){q++,E.addPolygonPath(v.coordinates,C,t);for(const w of v.coordinates)Z(w)}else if(v.type==="MultiPolygon"){K++;for(const w of v.coordinates){E.addPolygonPath(w,C,t);for(const D of w)Z(D)}}const J=v.type==="Polygon"?v.coordinates[0]:v.type==="MultiPolygon"?v.coordinates[0][0]:null;let S=k.id!=null?String(k.id):void 0;if(!S&&k.properties&&k.properties.id!=null&&(S=String(k.properties.id)),J&&J.length>0){const w=E.calculateCentroid(J,C);S&&(o.byFeatId.set(S,w),(h=k.properties)!=null&&h.GEOID20&&o.byGeoID20.set(String(k.properties.GEOID20),w),(m=k.properties)!=null&&m.GEOID&&o.byGeoID.set(String(k.properties.GEOID),w),i&&i.set(S,k),e&&e.set(S,v),r&&r.set(S,[W,X,U,Y]))}}const xt=N<F&&A<O?{minx:N,miny:A,maxx:F,maxy:O}:null,rt={minx:-87.74351,miny:41.730383,maxx:-87.528879,maxy:41.921598};return this.logger.log(`Geometry types: ${q} Polygon, ${K} MultiPolygon, ${Q} no geometry`),this.logger.log(`addPolygonPath was called ${E.pathCallCount} times`),this.logger.log(`CALCULATED BOUNDS: minx=${N}, miny=${A}, maxx=${F}, maxy=${O}`),this.logger.log("FORCING CORRECT BOUNDS from file analysis","warn"),this.logger.log(`Blocks loaded: ${t.length} polygons, ${o.byFeatId.size} centroids`,"success"),{blocksBounds:rt,detectedSwap:C}}catch(p){throw this.logger.warn(`Failed to load blocks.geojson: ${p.message} `),p}}async loadTree(t,o,i="data/trees"){try{this.logger.log(`Loading tree_${t}.json from ${i}...`);const e=await fetch(`${i}/tree_${t}.json`);if(!e.ok){if(e.status===404)return this.logger.log(`Tree iteration ${t} not found`,"info"),null;throw new Error(`HTTP ${e.status}`)}const r=await e.json();if(!r.nodes||!Array.isArray(r.nodes)||!r.links||!Array.isArray(r.links))throw new Error("Invalid tree JSON structure");const n=r.metadata||null,l=(n==null?void 0:n.root)!=null?String(n.root):null,s=[],c=[];for(const h of r.nodes){const m=String(h.id),p=h.GEOID20?String(h.GEOID20):null,I=h.GEOID?String(h.GEOID):null;let b=null;if(p&&(b=o.byGeoID20.get(p)),!b&&I&&(b=o.byGeoID.get(I)),b||(b=o.byFeatId.get(m)),!b&&h.x!=null&&h.y!=null&&(b=[h.x,h.y]),!b){c.push(m);continue}s.push({id:m,x:+b[0],y:+b[1],has_facility:h.has_facility??!1,compl_facility:h.compl_facility??!1,population:h.population??null,candidate:h.candidate??!1})}c.length>0&&this.logger.warn(`${c.length} nodes missing centroids`);const d=Object.fromEntries(s.map(h=>[h.id,h])),f=[];let g=0;for(const h of r.links){const m=String(h.source),p=String(h.target);d[m]&&d[p]?f.push({source:m,target:p}):g++}return this.logger.log(`Tree: ${s.length} nodes, ${f.length} links`,"success"),{nodes:s,links:f,nodesById:d,metadata:n,rootId:l}}catch(e){return this.logger.warn(`Failed to load tree_${t}.json: ${e.message}`),null}}async loadDistrict(t,o="data/districts"){try{this.logger.log(`Loading district_${t}.json from ${o}...`);const i=await fetch(`${o}/district_${t}.json`);if(!i.ok){if(i.status===404)return this.logger.log(`District iteration ${t} not found`,"info"),null;throw new Error(`HTTP ${i.status}`)}const e=await i.json();if(!e.district||!Array.isArray(e.district))throw new Error("Invalid district JSON structure");const r=e.district.map(s=>String(s)),n=e.metadata||{},l=this.generateDistrictColor(t);return this.logger.log(`District: ${r.length} nodes`,"success"),{nodes:r,metadata:n,color:l}}catch(i){return this.logger.warn(`Failed to load district_${t}.json: ${i.message}`),null}}computeDistrictBoundaries(t){this.logger.log("Computing district boundaries with Turf.js union...");const o=new Map,i=new Map,e=new Map;for(const[r,n]of t.blockIdToDistrictId.entries())e.has(n)||e.set(n,[]),e.get(n).push(r);this.logger.log(`Processing ${e.size} districts for boundary union...`);for(const[r,n]of e.entries())try{const l=[];for(const c of n){const d=t.blockIdToGeometry.get(c);d&&l.push({type:"Feature",geometry:d,properties:{}})}if(l.length===0)continue;let s=l[0];for(let c=1;c<l.length;c++)try{s=turf.union(s,l[c])}catch(d){console.warn(`Failed to union block in district ${r}:`,d)}if(s&&s.geometry){const c=new Path2D,d=s.geometry.coordinates;if(s.geometry.type==="Polygon")this.addToPath(c,d,t.detectedSwap);else if(s.geometry.type==="MultiPolygon")for(const h of d)this.addToPath(c,h,t.detectedSwap);o.set(r,c);const f=n[0],g=t.districtBlockColors.get(f);g&&i.set(r,g)}}catch(l){console.error(`Error processing district ${r}:`,l)}return this.logger.log(`Computed ${o.size} clean district boundaries via union`),{districtBoundaries:o,districtBoundaryColors:i}}addToPath(t,o,i){for(const e of o){if(!(e!=null&&e.length))continue;const r=i?[e[0][1],e[0][0]]:e[0];t.moveTo(r[0],r[1]);for(let n=1;n<e.length;n++){const l=i?[e[n][1],e[n][0]]:e[n];t.lineTo(l[0],l[1])}t.closePath()}}generateDistrictColor(t){const o=t*137.508%360,i=60+t%5*10,e=45+t%3*10;return`hsl(${o}, ${i}%, ${e}%)`}}class gt{constructor(t,o,i){this.canvas=t,this.ctx=t.getContext("2d"),this.config=o,this.visual=i}drawStarPath(t,o,i=3,e=5,r=.5){const n=Math.PI/2*3;let l=Math.PI/e;this.ctx.beginPath(),this.ctx.moveTo(t,o-i);let s=n;for(let c=0;c<e;c++)this.ctx.lineTo(t+Math.cos(s)*i,o+Math.sin(s)*i),s+=l,this.ctx.lineTo(t+Math.cos(s)*(i*r),o+Math.sin(s)*(i*r)),s+=l;this.ctx.closePath()}draw(t,o){var r,n;const i=this.ctx;i.save(),i.clearRect(0,0,this.canvas.width,this.canvas.height),i.translate(t.transform.x,t.transform.y),i.scale(t.transform.k,t.transform.k),i.translate(t.center.x,t.center.y),i.rotate(t.transform.angle),t.flipX&&i.scale(-1,1),i.translate(-t.center.x,-t.center.y);let e=new Set;if(t.viewMode==="district"&&t.districtColoring==="uncolored")for(const[l,s]of t.districtBlockColors.entries())e.add(l);if(t.blocksPaths.length>0){i.fillStyle=this.config.colors.blockFill,i.strokeStyle=this.config.colors.blockStroke,i.lineWidth=this.visual.blockLineWidth/t.transform.k;for(const l of t.blocksPaths)i.fill(l),i.stroke(l)}if(t.viewMode==="district"&&t.districtBlockColors.size>0)if(t.districtColoring==="colored")for(const[l,s]of t.districtBlockColors.entries()){const c=t.blockIdToGeometry.get(l);if(!c)continue;const d=t.blockIdToDistrictId.get(l),f=t.highlightDistrictId===d,h=t.highlightDistrictId&&!f?.3:1;let m=s,p="rgba(0, 0, 0, 0.3)",I=1/t.transform.k;if(f&&(m=this.lightenColor(s,20),p="#ffffff",I=3/t.transform.k),i.globalAlpha=h,c.type==="Polygon")this.drawGeometry(i,c.coordinates,m,p,I,t.detectedSwap);else if(c.type==="MultiPolygon")for(const b of c.coordinates)this.drawGeometry(i,b,m,p,I,t.detectedSwap);i.globalAlpha=1}else if(console.log("[RENDERER] Uncolored mode - boundaries size:",((r=t.districtBoundaries)==null?void 0:r.size)||0),console.log("[RENDERER] Boundary colors size:",((n=t.districtBoundaryColors)==null?void 0:n.size)||0),t.districtBoundaries&&t.districtBoundaries.size>0){console.log("[RENDERER] Drawing",t.districtBoundaries.size,"district boundaries");for(const[l,s]of t.districtBoundaries.entries()){const c=t.districtBoundaryColors.get(l);if(console.log(`[RENDERER] District ${l}: color=${c}`),!c)continue;const d=t.highlightDistrictId===l;i.globalAlpha=d?1:.85,i.fillStyle=d?this.lightenColor(c,20):c,i.fill(s),i.strokeStyle=d?"#ffffff":"rgba(0, 0, 0, 0.6)",i.lineWidth=d?4/t.transform.k:3/t.transform.k,i.stroke(s)}i.globalAlpha=1}else console.log("[RENDERER] No district boundaries to draw!");if(t.viewMode==="tree"){if(t.links.length>0){const l=t.highlightNodeId;i.globalAlpha=l?.3:1,i.strokeStyle=this.config.colors.linkStroke,i.lineWidth=this.visual.linkLineWidth/t.transform.k,i.beginPath();for(const s of t.links){const c=t.nodesById[s.source],d=t.nodesById[s.target];!c||!d||(i.moveTo(c.x,c.y),i.lineTo(d.x,d.y))}i.stroke(),i.globalAlpha=1}if(t.nodes.length>0){const l=Date.now(),s=t.highlightNodeId&&l<t.highlightUntil,c=s?Math.sin(l/100*Math.PI*2):0,d=t.highlightNodeId;for(const f of t.nodes){const g=f.id===t.rootId,h=s&&f.id===t.highlightNodeId,m=d&&!h?.3:1;i.globalAlpha=m;let p=null;if(t.nodeColorOverrides.has(f.id)?p=t.nodeColorOverrides.get(f.id):g?p=this.config.colors.rootFill:p=o(f)?this.config.colors.greenFill:this.config.colors.redFill,g){const I=this.config.rootOuterPx/t.transform.k;this.drawStarPath(f.x,f.y,I,5,this.config.rootInset),i.fillStyle=p,i.fill(),i.strokeStyle=this.config.colors.rootStroke,i.lineWidth=this.visual.rootLineWidth/t.transform.k,i.stroke()}else{const I=this.config.nodeRadiusPx/t.transform.k;i.beginPath(),i.arc(f.x,f.y,I,0,Math.PI*2),i.fillStyle=p,i.fill(),h?(i.strokeStyle=c>0?`rgba(255, 255, 100, ${.5+c*.5})`:"transparent",i.lineWidth=(2+c*2)/t.transform.k,i.stroke()):!t.nodeColorOverrides.has(f.id)&&o(f)&&(i.strokeStyle=this.config.colors.greenStroke,i.lineWidth=this.config.nodeStrokePx/t.transform.k,i.stroke())}i.globalAlpha=1}}}i.restore()}drawGeometry(t,o,i,e,r,n){const l=new Path2D;for(const s of o){if(!(s!=null&&s.length))continue;const c=n?[s[0][1],s[0][0]]:s[0];l.moveTo(c[0],c[1]);for(let d=1;d<s.length;d++){const f=n?[s[d][1],s[d][0]]:s[d];l.lineTo(f[0],f[1])}l.closePath()}t.fillStyle=i,t.fill(l),t.strokeStyle=e,t.lineWidth=r,t.stroke(l)}addToPath(t,o,i){for(const e of o){if(!(e!=null&&e.length))continue;const r=i?[e[0][1],e[0][0]]:e[0];t.moveTo(r[0],r[1]);for(let n=1;n<e.length;n++){const l=i?[e[n][1],e[n][0]]:e[n];t.lineTo(l[0],l[1])}t.closePath()}}lightenColor(t,o){if(t.startsWith("hsl")){const i=t.match(/hsl\((\d+\.?\d*),\s*(\d+)%,\s*(\d+)%\)/);if(i){let e=parseFloat(i[1]),r=parseInt(i[2]),n=parseInt(i[3]);return n=Math.min(100,n+o),`hsl(${e}, ${r}%, ${n}%)`}}return t}}class ht{isWithinTolerance(t,o){if(!o||t.population==null)return!1;const i=Number(t.population),e=Number(o.ideal_pop),r=Number(o.epsilon);if(!Number.isFinite(i)||!Number.isFinite(e)||!Number.isFinite(r))return!1;for(const n of[1,2]){const l=Math.abs(i-n*e),s=e*n*r;if(l<=s)return!0}return!1}}class ft{constructor(t,o){this.canvas=t,this.config=o}autoCenterAndScale(t){let o=1/0,i=1/0,e=-1/0,r=-1/0;if(t.blocksBounds&&(o=t.blocksBounds.minx,i=t.blocksBounds.miny,e=t.blocksBounds.maxx,r=t.blocksBounds.maxy,console.log(`Using blocks bounds: [${o}, ${i}, ${e}, ${r}]`)),t.nodes&&t.nodes.length){for(const g of t.nodes)Number.isFinite(g.x)&&Number.isFinite(g.y)&&(o=Math.min(o,g.x),i=Math.min(i,g.y),e=Math.max(e,g.x),r=Math.max(r,g.y));console.log(`Expanded for nodes: [${o}, ${i}, ${e}, ${r}]`)}if(console.log(`AutoCenter: Final Bounds [${o}, ${i}, ${e}, ${r}]`),!Number.isFinite(o)||!Number.isFinite(e)||!Number.isFinite(i)||!Number.isFinite(r))return console.warn("AutoCenter: Invalid bounds"),!1;if(!(o<e&&i<r))return console.warn("AutoCenter: Empty bounds range"),!1;const n=this.config.framePadding,l=Math.max(1e-9,e-o),s=Math.max(1e-9,r-i),c=(this.canvas.width-2*n)/l,d=(this.canvas.height-2*n)/s,f=Math.min(c,d);return t.center={x:(o+e)/2,y:(i+r)/2},t.transform.k=f,t.transform.x=n+(this.canvas.width-f*(o+e))/2,t.transform.y=n+(this.canvas.height-f*(i+r))/2,t.transform.angle=0,t.initialTransform={...t.transform},console.log(`AutoCenter: Transform k=${f}, x=${t.transform.x}, y=${t.transform.y}`),!0}getMousePos(t,o){const i=this.canvas.getBoundingClientRect(),e=t.clientX-i.left,r=t.clientY-i.top,n=(e-o.transform.x)/o.transform.k,l=(r-o.transform.y)/o.transform.k,s=n-o.center.x,c=l-o.center.y,d=Math.cos(-o.transform.angle),f=Math.sin(-o.transform.angle);let g=s*d-c*f+o.center.x,h=s*f+c*d+o.center.y;return o.flipX&&(g=2*o.center.x-g),{x:g,y:h}}}class ut{constructor(t,o){this.canvas=t,this.viewManager=o,this.isDragging=!1,this.dragStart=null}findNearestNode(t,o,i){let e=null,r=6/o.transform.k;for(const n of t){const l=Math.hypot(n.x-i.x,n.y-i.y);l<r&&(r=l,e=n)}return e}renderTooltip(t,o,i,e){const r=new Intl.NumberFormat("en-US"),n=(h,m=6)=>Number.isFinite(h)?h.toFixed(m):"N/A",l=t.population!=null?r.format(t.population):"N/A",s=i.isWithinTolerance(t,e)?"✅ within":"❌ outside",c=t.id===o.rootId?" (root)":"",d=o.links.filter(h=>h.source===t.id||h.target===t.id).length,f=o.nodeColorOverrides.get(t.id),g=f?`<div><b>District Color</b> <span style="display:inline-block;width:12px;height:12px;background:${f};border-radius:50%;vertical-align:middle;"></span></div>`:"";return`
            <div style="min-width: 250px; font-size: 12px; line-height: 1.6;">
                <div><b>Node ID</b> ${t.id}${c}</div>
                <div><b>Lon</b> ${n(t.x,6)}</div>
                <div><b>Lat</b> ${n(t.y,6)}</div>
                <div><b>Degree</b> ${d}</div>
                <div><b>Population:</b> ${l} <span style="padding:1px 6px;border-radius:999px;background:#eee;font-size:11px;">${s}</span></div>
                <hr style="border: none; border-top: 1px solid #ddd; margin: 6px 0;">
                <div><b>Has Facility:</b> ${t.has_facility?"✓":"✗"}</div>
                <div><b>Compl. Facility:</b> ${t.compl_facility?"✓":"✗"}</div>
                <div><b>Candidate:</b> ${t.candidate?"✓":"✗"}</div>
                ${g}
            </div>
        `}findBlockAt(t,o){const i=o.x,e=o.y;for(const[r,n]of t.blockIdToGeometry.entries()){if(!n||!n.coordinates)continue;const l=t.blockIdToBounds.get(r);if(l&&(i<l[0]||e<l[1]||i>l[2]||e>l[3]))continue;let s=!1;const c=d=>{let f=!1;for(let g=0,h=d.length-1;g<d.length;h=g++){const m=t.detectedSwap?d[g][1]:d[g][0],p=t.detectedSwap?d[g][0]:d[g][1],I=t.detectedSwap?d[h][1]:d[h][0],b=t.detectedSwap?d[h][0]:d[h][1];p>e!=b>e&&i<(I-m)*(e-p)/(b-p)+m&&(f=!f)}return f};if(n.type==="Polygon")c(n.coordinates[0])&&(s=!0);else if(n.type==="MultiPolygon"){for(const d of n.coordinates)if(c(d[0])){s=!0;break}}if(s)return r}return null}renderBlockMetadata(t,o){const i=o.blockIdToFeature.get(t),e=(i==null?void 0:i.properties)||{},r=o.districtBlockColors.get(t),n=o.blockIdToDistrictId.get(t),l=n?o.districtMetadata.get(n):null;let s=`
            <div style="margin-bottom:8px;">
                <div><b>Block ID:</b> ${t}</div>
                <div><b>GEOID:</b> ${e.GEOID20||e.GEOID||"N/A"}</div>
                <div><b>Population:</b> ${e.population||"N/A"}</div>
            </div>
        `;return r&&(s+=`
                <div style="border-top: 1px solid #eee; pt-2; mt-2;">
                    <div style="margin-bottom:4px;"><b>District ${n}</b> 
                        <span style="display:inline-block;width:12px;height:12px;background:${r};border-radius:50%;vertical-align:middle;"></span>
                    </div>
            `,l&&(l.center_node&&(s+=`<div><b>Center Node:</b> ${l.center_node}</div>`),l.population!=null&&(s+=`<div><b>Dist. Pop:</b> ${l.population}</div>`),l.radius!=null&&(s+=`<div><b>Radius:</b> ${l.radius.toFixed(4)}</div>`)),s+="</div>"),s}renderDistrictMetadata(t,o){var l;const i=o.districtMetadata.get(t),e=(l=[...o.districtBlockColors.entries()].find(([s,c])=>o.blockIdToDistrictId.get(s)===t))==null?void 0:l[1],r=[...o.blockIdToDistrictId.values()].filter(s=>s===t).length;let n=`
            <div style="margin-bottom:8px; font-size: 12px; line-height: 1.6;">
                <div style="margin-bottom:4px;"><b>District ${t}</b> 
                    <span style="display:inline-block;width:12px;height:12px;background:${e||"#ccc"};border-radius:50%;vertical-align:middle;"></span>
                </div>
                <div><b>Blocks:</b> ${r}</div>
            </div>
        `;return i&&(n+='<div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; font-size: 12px; line-height: 1.6;">',i.iteration!=null&&(n+=`<div><b>Iteration:</b> ${i.iteration}</div>`),i.district_id&&(n+=`<div><b>District ID:</b> ${i.district_id}</div>`),i.timestamp&&(n+=`<div><b>Timestamp:</b> ${i.timestamp}</div>`),i.root&&(n+=`<div><b>Root:</b> ${i.root}</div>`),i.tot_pop!=null&&(n+=`<div><b>Total Pop:</b> ${i.tot_pop}</div>`),i.hired_teams!=null&&(n+=`<div><b>Hired Teams:</b> ${i.hired_teams}</div>`),i.debt!=null&&(n+=`<div><b>Debt:</b> ${i.debt.toFixed(2)}</div>`),n+="</div>"),n}attachMouseListeners(t,o,i,e,r,n,l,s){const c=document.getElementById("districtMetadata");let d=!1,f={x:0,startAngle:0};t.addEventListener("mousedown",g=>{g.button===2?(g.preventDefault(),d=!0,f={x:g.clientX,y:g.clientY,startAngle:o.transform.angle}):(this.isDragging=!0,this.dragStart={x:g.clientX,y:g.clientY})}),t.addEventListener("mousemove",g=>{if(d){const h=g.clientX-f.x,m=.005;o.transform.angle=f.startAngle+h*m,e()}else if(this.isDragging)o.transform.x+=g.clientX-this.dragStart.x,o.transform.y+=g.clientY-this.dragStart.y,this.dragStart={x:g.clientX,y:g.clientY},e();else{const h=i.getMousePos(g,o);if(o.viewMode==="tree"){const m=this.findNearestNode(o.nodes,o,h);if(m){s.style.left=g.pageX+10+"px",s.style.top=g.pageY+10+"px",s.innerHTML=this.renderTooltip(m,o,n,l),s.style.display="block",c&&(c.innerHTML="<div style='color:#999;font-style:italic;'>Hover over a district...</div>"),o.highlightNodeId!==m.id&&(o.highlightNodeId=m.id,o.highlightBlockId=m.id,o.highlightDistrictId=null,o.highlightUntil=Date.now()+1e5,e());return}}if(o.viewMode==="district"){const m=this.findBlockAt(o,h);if(m){const p=o.blockIdToDistrictId.get(m);if(p&&o.districtBlockColors.has(m)){s.style.display="none",c&&(c.innerHTML=this.renderDistrictMetadata(p,o)),o.highlightDistrictId!==p&&(o.highlightDistrictId=p,o.highlightBlockId=null,o.highlightNodeId=null,e());return}}}s.style.display="none",(o.highlightNodeId||o.highlightBlockId||o.highlightDistrictId)&&(o.highlightNodeId=null,o.highlightBlockId=null,o.highlightDistrictId=null,c&&(c.innerHTML="<div style='color:#999;font-style:italic;'>Hover over a district...</div>"),e())}}),t.addEventListener("mouseup",()=>{this.isDragging=!1,d=!1}),t.addEventListener("mouseleave",()=>{this.isDragging=!1,d=!1,s.style.display="none",o.highlightNodeId=null,o.highlightBlockId=null,e()}),t.addEventListener("contextmenu",g=>(g.preventDefault(),!1)),t.addEventListener("wheel",g=>{g.preventDefault();const h=g.deltaY<0?1.1:.9,m=i.getMousePos(g,o);o.transform.x-=m.x*(h-1)*o.transform.k,o.transform.y-=m.y*(h-1)*o.transform.k,o.transform.k*=h,e()},{passive:!1})}}class mt{constructor(t,o,i){this.dataLoader=t,this.logger=o,this.config=i}async play(t,o,i,e){t.isPlaying||(t.isPlaying=!0,t.isPaused=!1,this.logger.log("Animation started","success"),this.animationStep(t,o,i,e))}pause(t){t.isPlaying=!1,t.isPaused=!0,this.logger.log("Animation paused","info")}stop(t,o){t.isPlaying=!1,t.isPaused=!1,t.iteration=0,t.nodes=[],t.links=[],t.nodesById={},t.districts.clear(),t.nodeColorOverrides.clear(),t.districtBlockColors.clear(),t.metadata=null,t.rootId=null,this.logger.log("Animation stopped","info"),o()}async animationStep(t,o,i,e){if(!t.isPlaying)return;const r=t.iteration+1;if(t.maxIteration&&r>t.maxIteration){this.pause(t),this.logger.log("Animation complete","success");return}t.iteration=r,document.getElementById("currentIter").textContent=r;const n=await this.dataLoader.loadTree(r,t.centroidMaps,t.treePath);n&&(t.nodes=n.nodes,t.links=n.links,t.nodesById=n.nodesById,t.metadata=n.metadata,t.rootId=n.rootId,e&&e());const l=await this.dataLoader.loadDistrict(r,t.districtPath);if(l){this.logger.log(`Loaded district ${r} with ${l.nodes.length} nodes`,"info"),t.districtMetadata.set(r,l.metadata);for(const s of l.nodes)t.nodeColorOverrides.set(s,l.color),t.districtBlockColors.set(s,l.color),t.blockIdToDistrictId.set(s,r);console.log(`District colors size: ${t.districtBlockColors.size}`)}else console.warn(`No district data for iteration ${r}`);o(),t.isPlaying&&setTimeout(()=>{this.animationStep(t,o,i,e)},this.config.animationDuration/t.animationSpeed)}async jumpToIteration(t,o,i,e,r,n){o.isPlaying=!1,o.iteration=t,document.getElementById("currentIter").textContent=t,this.logger.log(`Jumping to iteration ${t}`,"info");const l=await this.dataLoader.loadTree(t,r,o.treePath);if(l){o.nodes=l.nodes,o.links=l.links,o.nodesById=l.nodesById,o.metadata=l.metadata,o.rootId=l.rootId,n&&n(),e.autoCenterAndScale(o),o.nodeColorOverrides.clear(),o.districtBlockColors.clear(),o.blockIdToDistrictId.clear(),o.districtMetadata.clear();const s=[];for(let d=1;d<=t;d++)s.push(this.dataLoader.loadDistrict(d,o.districtPath));const c=await Promise.all(s);for(let d=0;d<c.length;d++){const f=c[d],g=d+1;if(f){o.districtMetadata.set(g,f.metadata);for(const h of f.nodes)o.nodeColorOverrides.set(h,f.color),o.districtBlockColors.set(h,f.color),o.blockIdToDistrictId.set(h,g)}}if(console.log(`Jump complete. Total colored blocks: ${o.districtBlockColors.size}`),t===o.maxIteration)try{console.log("[ANIM] Computing boundaries for FINAL iteration...");const{districtBoundaries:d,districtBoundaryColors:f}=this.dataLoader.computeDistrictBoundaries(o);o.districtBoundaries=d,o.districtBoundaryColors=f,console.log("[ANIM] Final boundaries computed:",d.size)}catch(d){console.error("[ANIM] Error computing final boundaries:",d)}i()}}}const a={iteration:0,isPlaying:!1,isPaused:!1,animationSpeed:1,blocksPaths:[],blocksBounds:null,centroidMaps:{byGeoID20:new Map,byGeoID:new Map,byFeatId:new Map},blockIdToFeature:new Map,nodes:[],links:[],nodesById:{},rootId:null,metadata:null,districts:new Map,nodeColorOverrides:new Map,districtBlockColors:new Map,blockIdToGeometry:new Map,blockIdToBounds:new Map,blockIdToDistrictId:new Map,districtMetadata:new Map,districtBoundaries:new Map,districtBoundaryColors:new Map,stateMode:"initial",viewMode:"district",districtColoring:"colored",treePath:"data/trees",districtPath:"data/districts",transform:{x:0,y:0,k:1,angle:0},initialTransform:null,center:{x:0,y:0},flipX:!1,highlightNodeId:null,highlightBlockId:null,highlightDistrictId:null,highlightUntil:0},P=document.getElementById("graphCanvas"),pt=document.getElementById("statusPanel"),yt=document.getElementById("tooltip"),y=new ct(pt,L),et=new at(y),bt=new gt(P,L,dt),nt=new ht,T=new ft(P,L),It=new ut(P,T),_=new mt(et,y,L);function V(){const u=a.stateMode==="initial"?"INITIAL":"INTERMEDIATE",t=a.viewMode==="district"?"DISTRICT":"TREE",o=a.districtColoring==="colored"?"Colored":"Uncolored";document.getElementById("currentStateMode").textContent=u,document.getElementById("currentViewMode").textContent=t,document.getElementById("currentColoringMode").textContent=o}function R(){P.width=window.innerWidth,P.height=window.innerHeight,console.log(`Canvas resized to: ${P.width}x${P.height}`),x()}window.addEventListener("resize",R);R();function G(){const u=document.getElementById("treeMetadata");if(!u)return;if(!a.metadata){u.innerHTML="<div style='color:#999;font-style:italic; font-size: 12px;'>No tree loaded</div>";return}const t=new Intl.NumberFormat("en-US"),o=(i,e)=>`<div style="margin:4px 0;font-size:11px;"><b style="color:#666;">${i}:</b> ${String(e)}</div>`;u.innerHTML=o("ideal_pop",t.format(a.metadata.ideal_pop||0))+o("root",a.metadata.root)+o("n_teams",a.metadata.n_teams)+o("epsilon",a.metadata.epsilon)+o("two_sided",a.metadata.two_sided)+o("tot_candidates",a.metadata.tot_candidates)+o("tot_pop",t.format(a.metadata.tot_pop||0))}function kt(){const u=document.getElementById("districtMetadata");if(!u)return;if(!a.districts||a.districts.size===0){u.innerHTML="<div style='color:#999;font-style:italic; font-size: 12px;'>No districts loaded</div>";return}let t='<div style="font-size: 12px; line-height: 1.6;">';const o=a.districts.keys().next().value;if(o!==void 0){const i=a.districts.get(o);t+=`<div><b>First District ID:</b> ${o}</div>`,i&&i.population&&(t+=`<div><b>Population:</b> ${new Intl.NumberFormat("en-US").format(i.population)}</div>`)}t+="</div>",u.innerHTML=t}function x(){G(),kt(),bt.draw(a,u=>nt.isWithinTolerance(u,a.metadata))}document.getElementById("playBtn").addEventListener("click",()=>{_.play(a,x,T,G)});document.getElementById("pauseBtn").addEventListener("click",()=>{_.pause(a)});document.getElementById("stopBtn").addEventListener("click",()=>{_.stop(a,x)});document.getElementById("finalBtn").addEventListener("click",()=>{a.maxIteration&&(y.log(`Jumping to final iteration ${a.maxIteration}...`,"info"),_.jumpToIteration(a.maxIteration,a,x,T,a.centroidMaps,G))});const ot=document.getElementById("resetViewBtn");ot&&ot.addEventListener("click",()=>{T.resetView(a),x()});document.getElementById("speedSlider").addEventListener("input",u=>{a.animationSpeed=parseFloat(u.target.value),document.getElementById("speedLabel").textContent=`${a.animationSpeed}x`,y.log(`Speed: ${a.animationSpeed}x`)});document.getElementById("goBtn").addEventListener("click",async()=>{const u=parseInt(document.getElementById("iterationInput").value,10);if(isNaN(u)||u<0){y.warn("Invalid iteration number");return}await _.jumpToIteration(u,a,x,T,a.centroidMaps,G)});document.getElementById("debugMode").addEventListener("change",u=>{L.debug=u.target.checked,y.log(`Debug mode: ${L.debug?"ON":"OFF"}`)});document.getElementById("toggleStateBtn").addEventListener("click",u=>{a.stateMode==="initial"?(a.stateMode="intermediate",u.target.textContent="Switch to Initial",a.treePath="data/int_trees",a.districtPath="data/int_districts",y.log("Switched to Intermediate Mode"),a.viewMode==="district"&&(document.getElementById("toggleColoringBtn").style.display="inline-block")):(a.stateMode="initial",u.target.textContent="Switch to Intermediate",a.treePath="data/trees",a.districtPath="data/districts",a.districtColoring="colored",y.log("Switched to Initial Mode"),document.getElementById("toggleColoringBtn").style.display="none",document.getElementById("toggleColoringBtn").textContent="Show Uncolored"),V(),x()});document.getElementById("toggleModeBtn").addEventListener("click",u=>{a.viewMode==="district"?(a.viewMode="tree",u.target.textContent="Switch to District Mode",document.getElementById("toggleColoringBtn").style.display="none",y.log("Switched to Tree Mode")):(a.viewMode="district",u.target.textContent="Switch to Tree Mode",a.stateMode==="intermediate"&&(document.getElementById("toggleColoringBtn").style.display="inline-block"),y.log("Switched to District Mode")),V(),x()});const it=document.getElementById("toggleColoringBtn");it&&it.addEventListener("click",u=>{a.districtColoring==="colored"?(a.districtColoring="uncolored",u.target.textContent="Show Colored",y.log("Districts: Uncolored view")):(a.districtColoring="colored",u.target.textContent="Show Uncolored",y.log("Districts: Colored view")),V(),x()});It.attachMouseListeners(P,a,T,x,a.nodes,nt,a.metadata,yt);addEventListener("resize",R);async function vt(){var u,t;try{y.updateStatus("Initializing...","info"),y.log("Starting initialization..."),y.log("Loading blocks.json...");const{blocksBounds:o,detectedSwap:i}=await et.loadBlocks(a.blocksPaths,a.centroidMaps,a.blockIdToFeature,a.blockIdToGeometry,a.blockIdToBounds);y.log(`Blocks loaded. blocksPaths length: ${a.blocksPaths.length}`),y.log(`VERIFY: blocksPaths[0] type = ${(t=(u=a.blocksPaths[0])==null?void 0:u.constructor)==null?void 0:t.name}`),y.log(`VERIFY: blocksPaths is array? ${Array.isArray(a.blocksPaths)}`),a.blocksBounds=o,a.detectedSwap=i,y.log(`Blocks bounds set: ${JSON.stringify(o)}`),y.log("Resizing canvas..."),R(),y.log("Setting initial view..."),T.autoCenterAndScale(a),R(),x(),y.log("Initial render complete");let e=1;for(let r=1;r<1e4;r++){const n=await fetch(`data/trees/tree_${r}.json`,{method:"HEAD"});if(n.ok)e=r;else{if(n.status===404)break;y.warn(`Error checking file tree_${r}.json: Status ${n.status}`);break}}a.maxIteration=e,y.log(`Ready! Max iterations: ${a.maxIteration}`,"success")}catch(o){y.error(`Init failed: ${o.message}`),y.error(`Stack: ${o.stack}`),console.error("Initialization error:",o)}}vt();
